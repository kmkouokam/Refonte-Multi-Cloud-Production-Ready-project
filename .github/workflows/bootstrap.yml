name: ArgoCD Bootstrap

on:
  push:
    branches:
      - flask-app

env:
  GCP_CLUSTER_NAME: my-gcp-cluster-5e704c9d76a3
  GCP_REGION: us-east4
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  AWS_CLUSTER_NAME: multi-cloud-cluster
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  aws-bootstrap:
    name: Bootstrap AWS
    runs-on: [self-hosted, linux, vpc-runner]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS kubeconfig
        run: |
          aws eks update-kubeconfig --name multi-cloud-cluster --region ${{ secrets.AWS_REGION }}

      - name: Install ArgoCD on AWS
        run: |
           kubectl create namespace argocd || true
           kubectl apply -n argocd \
             -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml --validate=false

            kubectl apply \
             -f https://raw.githubusercontent.com/argoproj/argo-rollouts/stable/manifests/install.yaml
           kubectl wait --for=condition=ready pod -n argocd --selector=app.kubernetes.io/name=argocd-server --timeout=300s

           # Wait additionally until the argocd-cm exists
           until kubectl get configmap argocd-cm -n argocd >/dev/null 2>&1; do
             echo "Waiting for argocd-cm to be created..."
             sleep 5
           done

      - name: Argocd ports forwarding
        run: |
          kubectl port-forward -n argocd svc/argocd-server 8080:443 &
          sleep 10     

      - name: Fetch ArgoCD admin password
        run: |
          ARGO_PWD=$(kubectl -n argocd get secret argocd-initial-admin-secret \
          -o jsonpath="{.data.password}" | base64 -d)
          echo "ARGOCD_ADMIN_PASSWORD=$ARGO_PWD" >> $GITHUB_ENV

      - name: Login ArgoCD
        run: |
          argocd login localhost:8080 \
            --username admin \
            --password $ARGOCD_ADMIN_PASSWORD \
            --insecure

      - name: Register AWS cluster
        run: argocd cluster add multi-cloud-cluster --label cloud=aws

  gcp-bootstrap:
    name: Bootstrap GCP
    runs-on: [self-hosted, linux, vpc-runner]
    needs: aws-bootstrap   # ensures AWS job runs first
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Install gcloud ---
      - name: Install Google Cloud SDK
        run: |
          # Create safe directory
          mkdir -p /home/ec2-user/gcloud
          cd /home/ec2-user/gcloud 
          # Detect package manager
          if command -v apt-get >/dev/null 2>&1; then
           sudo apt-get update -y
           sudo apt-get install -y apt-transport-https ca-certificates gnupg curl
          elif command -v yum >/dev/null 2>&1 || command -v dnf >/dev/null 2>&1; then
           sudo yum update -y || sudo dnf update -y
           sudo yum install -y curl ca-certificates || sudo dnf install -y curl ca-certificates
          else
            echo "No supported package manager found"
           exit 1
          fi

           # If using apt-get, install Google Cloud SDK via apt repo
          if command -v apt-get >/dev/null 2>&1; then
            curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
            echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | \
            sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
            sudo apt-get update
            sudo apt-get install -y google-cloud-sdk
          else
          # For Amazon Linux 2023 or other yum/dnf distros, use Google's install script
            sudo -u ec2-user bash
            cd ~
            curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-cli-linux-x86_64.tar.gz
            tar -xf google-cloud-cli-linux-x86_64.tar.gz
             ./google-cloud-sdk/install.sh --quiet
            echo 'source $HOME/google-cloud-sdk/path.bash.inc' >> ~/.bashrc
            echo 'source $HOME/google-cloud-sdk/completion.bash.inc' >> ~/.bashrc
            source ~/.bashrc
           fi

      - name: Install GKE auth plugin and authenticate to GCP
        run: |
          # Install gke plugin
           gcloud components install gke-gcloud-auth-plugin --quiet

           # Authenticate to GCP
            echo "${{ secrets.GCP_SA_KEY }}" | base64 --decode > gcp-key.json
            gcloud auth activate-service-account --key-file=gcp-key.json --quiet
            # Verify
            gcloud version
            kubectl version --client

      - name: Update kubeconfig GCP
        run: |
          echo "Cluster: $GCP_CLUSTER_NAME, Region: $GCP_REGION, Project: $GCP_PROJECT_ID"
          gcloud container clusters get-credentials "$GCP_CLUSTER_NAME" \
            --region "$GCP_REGION" \
            --project "$GCP_PROJECT_ID"

      - name: Install ArgoCD on GCP
        run: |
           kubectl create namespace argocd || true
           kubectl apply -n argocd \
             -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml --validate=false

            kubectl apply \
             -f https://raw.githubusercontent.com/argoproj/argo-rollouts/stable/manifests/install.yaml
           kubectl wait --for=condition=ready pod -n argocd --selector=app.kubernetes.io/name=argocd-server --timeout=300s

           # Wait additionally until the argocd-cm exists
           until kubectl get configmap argocd-cm -n argocd >/dev/null 2>&1; do
             echo "Waiting for argocd-cm to be created..."
             sleep 5
           done

      - name: Argocd ports forwarding
        run: |
          kubectl port-forward -n argocd svc/argocd-server 8080:443 &
          sleep 10


      - name: Fetch ArgoCD admin password
        run: |
          ARGO_PWD=$(kubectl -n argocd get secret argocd-initial-admin-secret \
          -o jsonpath="{.data.password}" | base64 -d)
          echo "ARGOCD_ADMIN_PASSWORD=$ARGO_PWD" >> $GITHUB_ENV

      - name: Login ArgoCD
        run: |
          argocd login localhost:8080 \
            --username admin \
            --password $ARGOCD_ADMIN_PASSWORD \
            --insecure

      - name: Register GCP cluster
        run: argocd cluster add $GCP_CLUSTER_NAME --label cloud=gcp
 