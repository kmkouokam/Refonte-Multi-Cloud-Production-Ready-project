name: ArgoCD Bootstrap

on:
  push:
    branches:
      - flask-app

env:
  GCP_CLUSTER_NAME: my-gcp-cluster-5e704c9d76a3
  GCP_REGION: us-east4
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

jobs:
  aws-bootstrap:
    name: Bootstrap AWS
    runs-on: [self-hosted, linux, vpc-runner]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS kubeconfig
        run: |
          aws eks update-kubeconfig --name multi-cloud-cluster --region ${{ secrets.AWS_REGION }}

      - name: Install ArgoCD on AWS
        run: |
           kubectl create namespace argocd || true
           kubectl apply -n argocd \
             -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml --validate=false

            kubectl apply \
             -f https://raw.githubusercontent.com/argoproj/argo-rollouts/stable/manifests/install.yaml
           kubectl wait --for=condition=ready pod -n argocd --selector=app.kubernetes.io/name=argocd-server --timeout=300s

           # Wait additionally until the argocd-cm exists
           until kubectl get configmap argocd-cm -n argocd >/dev/null 2>&1; do
             echo "Waiting for argocd-cm to be created..."
             sleep 5
           done

      - name: Fetch ArgoCD admin password
        run: |
          ARGO_PWD=$(kubectl -n argocd get secret argocd-initial-admin-secret \
          -o jsonpath="{.data.password}" | base64 -d)
          echo "ARGOCD_ADMIN_PASSWORD=$ARGO_PWD" >> $GITHUB_ENV

      - name: Login ArgoCD
        run: |
          argocd login https://localhost:8080 \
            --username admin \
            --password $ARGOCD_ADMIN_PASSWORD \
            --insecure

      - name: Register AWS cluster
        run: argocd cluster add multi-cloud-cluster --label cloud=aws

  gcp-bootstrap:
    name: Bootstrap GCP
    runs-on: [self-hosted, linux, vpc-runner]
    needs: aws-bootstrap   # ensures AWS job runs first
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Install gcloud ---
      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          install_components: "kubectl"

      - name: Authenticate to GCP
        run: |
          echo "${{ secrets.GCP_SA_KEY }}" | base64 --decode > gcp-key.json
          gcloud auth activate-service-account --key-file=gcp-key.json

      - name: Update kubeconfig GCP
        run: |
          echo "Cluster: $GCP_CLUSTER_NAME, Region: $GCP_REGION, Project: $GCP_PROJECT_ID"
          gcloud container clusters get-credentials "$GCP_CLUSTER_NAME" \
            --region "$GCP_REGION" \
            --project "$GCP_PROJECT_ID"

      - name: Install ArgoCD on GCP
        run: |
           kubectl create namespace argocd || true
           kubectl apply -n argocd \
             -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml --validate=false

            kubectl apply \
             -f https://raw.githubusercontent.com/argoproj/argo-rollouts/stable/manifests/install.yaml
           kubectl wait --for=condition=ready pod -n argocd --selector=app.kubernetes.io/name=argocd-server --timeout=300s

           # Wait additionally until the argocd-cm exists
           until kubectl get configmap argocd-cm -n argocd >/dev/null 2>&1; do
             echo "Waiting for argocd-cm to be created..."
             sleep 5
           done


      - name: Fetch ArgoCD admin password
        run: |
          ARGO_PWD=$(kubectl -n argocd get secret argocd-initial-admin-secret \
          -o jsonpath="{.data.password}" | base64 -d)
          echo "ARGOCD_ADMIN_PASSWORD=$ARGO_PWD" >> $GITHUB_ENV

      - name: Login ArgoCD
        run: |
          argocd login https://localhost:8080 \
            --username admin \
            --password $ARGOCD_ADMIN_PASSWORD \
            --insecure

      - name: Register GCP cluster
        run: argocd cluster add $GCP_CLUSTER_NAME --label cloud=gcp
 