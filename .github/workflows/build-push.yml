name: Build and Push Flask App Image

on:
  push:
    branches: ["flask-app"]

permissions:
  contents: write
  id-token: write

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  IMAGE_NAME: flask-app

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2️⃣ Configure AWS credentials and login to ECR
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to AWS ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION | \
          docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      # 3️⃣ Authenticate to GCP
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: "projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/GITHUB/providers/gh"
          service_account: "github-deployer@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com"

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      # 4️⃣ Build Docker images
      - name: Build Docker Images
        run: |
          cd flask-app
          docker build -t $IMAGE_NAME .
          docker tag $IMAGE_NAME:latest $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:${GITHUB_SHA}
          docker tag $IMAGE_NAME:latest us-central1-docker.pkg.dev/$GCP_PROJECT_ID/my-repo/$IMAGE_NAME:${GITHUB_SHA}

      # 5️⃣ Push Docker images
      - name: Push Docker Images
        run: |
          docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:${GITHUB_SHA}
          docker push us-central1-docker.pkg.dev/$GCP_PROJECT_ID/my-repo/$IMAGE_NAME:${GITHUB_SHA}

      # 6️⃣ Update Rollout manifests in gitop branch
      - name: Update gitop branch with new images
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Clone gitop branch
          git clone --branch gitop https://github.com/${{ github.repository }} gitop
          cd gitop/k8s/flask-app

          # Update AWS Rollout image
          sed -i "s|image: .*|image: $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:${GITHUB_SHA}|" flask-app-aws-rollout.yaml

          # Update GCP Rollout image
          sed -i "s|image: .*|image: us-central1-docker.pkg.dev/$GCP_PROJECT_ID/my-repo/$IMAGE_NAME:${GITHUB_SHA}|" flask-app-gcp-rollout.yaml

          # Commit & push changes
          git add flask-app-aws-rollout.yaml flask-app-gcp-rollout.yaml
          git commit -m "Update Rollout images for $GITHUB_SHA"
          git push origin gitop

      # 7️⃣ Notify on completion
      - name: Notify on workflow completion
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS="${{ job.status }}"
          COMMIT=$GITHUB_SHA
          REPO=$GITHUB_REPOSITORY

          # 1️⃣ Console log
          if [ "$STATUS" == "success" ]; then
            echo "✅ Build & push succeeded for $COMMIT"
          else
            echo "❌ Build & push failed for $COMMIT"
          fi

          # 2️⃣ Slack notification
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"Build & push workflow completed: *$STATUS* for commit $COMMIT in repo $REPO\"}" \
            $SLACK_WEBHOOK_URL

          # # 3️⃣ Email notification (if SMTP configured)
          # echo -e "Subject: Build & Push Status - $STATUS\n\nThe workflow for commit $COMMIT in repo $REPO has finished with status: $STATUS." \
          #   | sendmail -v team@example.com
